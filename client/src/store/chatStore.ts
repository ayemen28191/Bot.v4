import { create } from 'zustand';
import { Message } from '@/types';
import NotificationService from '@/lib/notifications';
import { getWebSocketUrl } from '@/lib/queryClient';

// ุชุญุฏูุฏ ุญุฌู ุงููุฎุฒู ุงููุคูุช (ูู ุนุฏุฏ ุงูุฑุณุงุฆู ุงูุชู ุณูุชู ุชุฎุฒูููุง ุจุญุฏ ุฃูุตู)
const MAX_CACHED_MESSAGES = 100;
// ูุฏุฉ ุตูุงุญูุฉ ุงูุจูุงูุงุช ุงููุฎุฒูุฉ (ุจุงููููู ุซุงููุฉ) - 7 ุฃูุงู
const CACHE_EXPIRY = 7 * 24 * 60 * 60 * 1000;

// ูุงุฌูุฉ ููุนูููุงุช ุงูุจูุงูุงุช ุงููุฎุฒูุฉ
interface CachedData<T> {
  data: T;
  timestamp: number;
  version: string;
}

interface ChatState {
  messages: Message[];
  socket: WebSocket | null;
  isConnected: boolean;
  onlineUsers: number;
  isOfflineMode: boolean;
  pendingMessages: Message[];
  lastSyncTimestamp: null | number;
  sendMessage: (text: string, sender: string, avatar: string) => void;
  initializeWebSocket: () => void;
  enableOfflineMode: () => void;
  disableOfflineMode: () => void;
  syncMessages: () => Promise<void>;
  clearMessages: () => void;
  wsFailedAttempts: number; // ุฅุถุงูุฉ ุนุฏุงุฏ ูููุญุงููุงุช ุงููุงุดูุฉ
  handleConnectionFailure: (reason: string) => void; // ุฏุงูุฉ ูุณุงุนุฏุฉ ููุชุนุงูู ูุน ูุดู ุงูุงุชุตุงู
  addMessage: (message: Message) => void; // ุฏุงูุฉ ูุณุงุนุฏุฉ ูุฅุถุงูุฉ ุงูุฑุณุงุฆู
}

// ุฏุงูุฉ ูุณุงุนุฏุฉ ูุญูุธ ุงูุจูุงูุงุช ูู ุงูุชุฎุฒูู ุงููุญูู ูุน ูุนูููุงุช ุงูุตูุงุญูุฉ
const saveToLocalStorage = <T>(key: string, data: T, version: string = '1.0.0'): boolean => {
  try {
    const cachedData: CachedData<T> = {
      data,
      timestamp: Date.now(),
      version
    };
    localStorage.setItem(key, JSON.stringify(cachedData));
    return true;
  } catch (error) {
    console.error(`Error saving data (${key}):`, error);
    return false;
  }
};

// ุฏุงูุฉ ูุณุงุนุฏุฉ ูุงุณุชุฑุฌุงุน ุงูุจูุงูุงุช ูู ุงูุชุฎุฒูู ุงููุญูู ูุน ุงูุชุญูู ูู ุงูุตูุงุญูุฉ
const getFromLocalStorage = <T>(key: string, defaultValue: T, ttl: number = CACHE_EXPIRY): T => {
  try {
    const savedData = localStorage.getItem(key);
    if (!savedData) return defaultValue;

    const parsed = JSON.parse(savedData) as CachedData<T>;

    // ุงูุชุญูู ูู ุตูุงุญูุฉ ุงูุจูุงูุงุช
    const isValid = Date.now() - parsed.timestamp < ttl;
    if (!isValid) {
      localStorage.removeItem(key);
      return defaultValue;
    }

    return parsed.data;
  } catch (error) {
    console.error(`Error reading data (${key}):`, error);
    return defaultValue;
  }
};

export const useStore = create<ChatState>((set, get) => {
  // **ุญูุงูุฉ ูุจูุฑุฉ ูู ุญููุฉ ุฅุนุงุฏุฉ ุงูุชุญููู**
  if (typeof window !== 'undefined') {
    // ูุญุต ููุฑู ููุจูุฆุฉ ุงูุขููุฉ
    const isSecure = window.location.protocol === 'https:';
    const isReplitApp = window.location.hostname.includes('replit') || 
                        window.location.hostname.endsWith('.repl.co');
    
    // ุชูุนูู ุงูุญูุงูุฉ ุงููุจูุฑุฉ ููุฑุงู
    if (isSecure && isReplitApp) {
      const currentOfflineState = localStorage.getItem('offlineMode') === 'enabled' ||
                                  localStorage.getItem('offline_mode') === 'enabled' ||
                                  localStorage.getItem('replit_https_protection') === 'enabled';
      
      if (!currentOfflineState) {
        console.log('๐ก๏ธ ุชูุนูู ุงูุญูุงูุฉ ุงููุจูุฑุฉ ูู ุญููุฉ ุฅุนุงุฏุฉ ุงูุชุญููู');
        console.log('โน๏ธ This protection prevents WebSocket issues in HTTPS environment - normal behavior');
        localStorage.setItem('offline_mode', 'enabled');
        localStorage.setItem('replit_https_protection', 'enabled');
      }
    }

    // ุฅุนุฏุงุฏ ูุณุชูุน ุงูุฃุญุฏุงุซ ูุชูุนูู ูุถุน ุนุฏู ุงูุงุชุตุงู ูู ุฎุงุฑุฌ ุงููุฎุฒู
    window.addEventListener('enableOfflineMode', (event: any) => {
      const store = get();
      if (!store.isOfflineMode) {
        console.log('Offline mode enabled by external event', event?.detail);
        store.enableOfflineMode();
      }
    });
  }

  return {
    messages: (() => {
      try {
        if (typeof window === 'undefined') return [];

        // ุงูุชุญูู ุฅุฐุง ูุงู ูุถุน ุนุฏู ุงูุงุชุตุงู ููุนู ูุณุจูุง
        const offlineMode = localStorage.getItem('offline_mode') === 'enabled';

        // ูุญุงููุฉ ูุฑุงุกุฉ ุงูุจูุงูุงุช ุจุงูุชูุณูู ุงูุฌุฏูุฏ ุฃููุงู
        const messagesData = getFromLocalStorage<Message[]>('chat_data', []);
        if (messagesData && messagesData.length > 0) {
          return messagesData;
        }

        // ุงูุฑุฌูุน ููุชูุณูู ุงููุฏูู ูุงุญุชูุงุท
        const saved = localStorage.getItem('chat_messages');
        if (saved) {
          const parsedMessages = JSON.parse(saved);
          // ุญูุธ ุงูุจูุงูุงุช ุจุงูุชูุณูู ุงูุฌุฏูุฏ ููุงุณุชุฎุฏุงู ูู ุงููุณุชูุจู
          saveToLocalStorage('chat_data', parsedMessages);
          return parsedMessages;
        }

        return [];
      } catch (e) {
        console.error('Error reading messages from local storage:', e);
        return [];
      }
    })(),
    socket: null,
    isConnected: false,
    onlineUsers: 1000,
    // ูุฑุงุกุฉ ุญุงูุฉ ูุถุน ุนุฏู ุงูุงุชุตุงู ูู ุงูุชุฎุฒูู ุงููุญูู
    isOfflineMode: typeof window !== 'undefined' && (
      localStorage.getItem('offlineMode') === 'enabled' ||
      localStorage.getItem('offline_mode') === 'enabled'
    ),
    pendingMessages: [],
    lastSyncTimestamp: null,
    wsFailedAttempts: 0, // ุชููุฆุฉ ุนุฏุงุฏ ุงููุญุงููุงุช ุงููุงุดูุฉ

    // ุฏุงูุฉ ูุณุงุนุฏุฉ ูุฅุถุงูุฉ ุงูุฑุณุงุฆู ุฅูู ุงูุญุงูุฉ
    addMessage: (message: Message) => {
      set(state => {
        // ุชุฌูุจ ุชูุฑุงุฑ ุงูุฑุณุงุฆู ุนู ุทุฑูู ูุญุต ุงููุนุฑู ุงููุฑูุฏ
        const isDuplicate = state.messages.some(msg => msg.id === message.id);
        if (isDuplicate) {
          return state; // ูุง ุชุบููุฑ ุฅุฐุง ูุงูุช ุงูุฑุณุงูุฉ ููุฑุฑุฉ
        }

        const newMessages = [...state.messages, message];

        // ุญูุธ ุงูุฑุณุงุฆู ูู ุงูุชุฎุฒูู ุงููุญูู ุจููุง ุงูุชูุณูููู
        try {
          localStorage.setItem('chat_messages', JSON.stringify(newMessages));
          saveToLocalStorage('chat_data', newMessages);
        } catch (error) {
          console.warn('Failed to save messages to local storage:', error);
        }

        // ุฅุฑุณุงู ุฅุดุนุงุฑ ูููุณุชุฎุฏู ุฅุฐุง ูุงูุช ุงูุฑุณุงูุฉ ูู ุดุฎุต ุขุฎุฑ (ููุณุช ุฑุณุงูุฉ ุงููุณุชุฎุฏู ููุณู)
        try {
          const currentUser = localStorage.getItem('current_user');
          const isSelfMessage = currentUser && message.sender === currentUser;

          // ุฅุฑุณุงู ุฅุดุนุงุฑ ููุท ุฅุฐุง ูุงูุช ุงูุฑุณุงูุฉ ูู ุดุฎุต ุขุฎุฑ ูููุณุช ูู ููุณ ุงููุณุชุฎุฏู
          if (!isSelfMessage && message.sender !== 'System' && !document.hasFocus()) {
            NotificationService.sendChatMessage({
              sender: message.sender,
              text: message.text
            });
          }
        } catch (notifyError) {
          console.warn('Could not send notification for new message:', notifyError);
        }

        return { messages: newMessages };
      });
    },

    initializeWebSocket: () => {
      try {
        const isOfflineMode = get().isOfflineMode;
        if (isOfflineMode) {
          console.log('๐ ูุถุน ุนุฏู ุงูุงุชุตุงู ููุนูุ ุชุฎุทู ุฅูุดุงุก WebSocket');
          set({ isConnected: false, socket: null });
          return;
        }

        // ุฅุบูุงู ุงูุงุชุตุงู ุงูุณุงุจู ุฅู ููุฌุฏ
        const existingSocket = get().socket;
        if (existingSocket && existingSocket.readyState !== WebSocket.CLOSED) {
          console.log('ุฅุบูุงู ุงุชุตุงู WebSocket ุงูุณุงุจู...');
          existingSocket.close();
        }

        console.log('ุชููุฆุฉ ุงุชุตุงู WebSocket ุฌุฏูุฏ...');
        const wsUrl = getWebSocketUrl('/ws');

        // ุงูุชุญูู ูู ุตุญุฉ URL ูุจู ุฅูุดุงุก ุงูุงุชุตุงู
        if (wsUrl.includes('offline') || wsUrl.includes('replit-https-offline')) {
          console.log('๐ ุชู ุงูุชุดุงู ูุถุน ุนุฏู ุงูุงุชุตุงู ูู URLุ ุชูุนูู ูุถุน ุนุฏู ุงูุงุชุตุงู');
          get().enableOfflineMode();
          return;
        }

        console.log('๐ ูุญุงููุฉ ุงูุงุชุตุงู ุจู:', wsUrl);
        const ws = new WebSocket(wsUrl);

        // ุชุนููู timeout ููุงุชุตุงู
        const connectionTimeout = setTimeout(() => {
          if (ws.readyState === WebSocket.CONNECTING) {
            console.warn('โฐ ุงูุชูุช ูููุฉ ุงูุงุชุตุงู ุจู WebSocket');
            ws.close();
            get().handleConnectionFailure('timeout');
          }
        }, 10000); // 10 ุซูุงูู timeout

        ws.onopen = () => {
          console.log('โ ุชู ุงูุงุชุตุงู ุจู WebSocket ุจูุฌุงุญ');
          clearTimeout(connectionTimeout);
          set({ isConnected: true, socket: ws, wsFailedAttempts: 0 });

          // ุฒูุงุฏุฉ ุนุฏุฏ ุงููุณุชุฎุฏููู ุงููุชุตููู (ูุญุงูุงุฉ)
          set(state => ({ onlineUsers: state.onlineUsers + Math.floor(Math.random() * 3) + 1 }));
        };

        ws.onmessage = (event) => {
          console.log('๐จ ุฑุณุงูุฉ ูุงุฑุฏุฉ ุนุจุฑ WebSocket:', event.data);
          try {
            const data = JSON.parse(event.data);
            if (data.type === 'message') {
              get().addMessage(data.message);
            }
          } catch (error) {
            console.error('ุฎุทุฃ ูู ุชุญููู ุฑุณุงูุฉ WebSocket:', error);
          }
        };

        ws.onerror = (error) => {
          console.error('โ ุฎุทุฃ ูู WebSocket:', error);
          clearTimeout(connectionTimeout);
          get().handleConnectionFailure('error');
        };

        ws.onclose = (event) => {
          console.log('โ ุชู ุฅุบูุงู ุงุชุตุงู WebSocket:', event.code, event.reason);
          clearTimeout(connectionTimeout);
          set({ isConnected: false, socket: null });

          // ุชูููู ุนุฏุฏ ุงููุณุชุฎุฏููู ุงููุชุตููู
          set(state => ({
            onlineUsers: Math.max(1, state.onlineUsers - Math.floor(Math.random() * 2) - 1)
          }));

          // ุงูุชุนุงูู ูุน ุฑููุฒ ุงูุฃุฎุทุงุก ุงููุฎุชููุฉ
          if (event.code === 1006 || event.code === 502) {
            console.warn('๐ซ ุฎุทุฃ 502 ุฃู ูุดู ุงูุงุชุตุงู - ูุฏ ุชููู ูุดููุฉ ูู ุจูุฆุฉ HTTPS');
            get().handleConnectionFailure('502_or_connection_failed');
          } else if (!get().isOfflineMode) {
            get().handleConnectionFailure('normal_close');
          }
        };

        set({ socket: ws });
      } catch (error) {
        console.error('Failed to initialize WebSocket:', error);
        get().handleConnectionFailure('exception');
      }
    },

    // ุฏุงูุฉ ูุณุงุนุฏุฉ ููุชุนุงูู ูุน ูุดู ุงูุงุชุตุงู
    handleConnectionFailure: (reason: string) => {
      const currentAttempts = get().wsFailedAttempts || 0;
      const newAttempts = currentAttempts + 1;
      set({ wsFailedAttempts: newAttempts });

      console.log(`๐ ูุดู ุงูุงุชุตุงู (${reason}), ุงููุญุงููุฉ: ${newAttempts}`);

      // ุฅุฐุง ูุดู ุงูุงุชุตุงู ุฃูุซุฑ ูู 3 ูุฑุงุช ุฃู ูุงู ุงูุณุจุจ 502ุ ูู ุจุชูุนูู ูุถุน ุนุฏู ุงูุงุชุตุงู
      if (newAttempts >= 3 || reason === '502_or_connection_failed' || reason === 'timeout') {
        console.log('๐ ุชูุนูู ูุถุน ุนุฏู ุงูุงุชุตุงู ุจุณุจุจ ูุดู ุงูุงุชุตุงู ุงููุชูุฑุฑ');

        try {
          const { toast } = require('@/hooks/use-toast');
          toast({
            title: "Connection Issues Detected",
            description: "Switching to offline mode for better stability. You can switch back to online mode later.",
            variant: "default",
            duration: 5000
          });
        } catch (toastError) {
          console.warn('Failed to display offline mode notification:', toastError);
        }

        get().enableOfflineMode();
        return;
      }

      // ุฅุนุงุฏุฉ ุงููุญุงููุฉ ูุน ุชุฃุฎูุฑ ุชุฏุฑูุฌู
      if (!get().isOfflineMode) {
        const delay = Math.min(2000 * Math.pow(1.5, newAttempts), 15000);
        console.log(`๐ ุฅุนุงุฏุฉ ูุญุงููุฉ ุงูุงุชุตุงู ุฎูุงู ${delay}ms`);

        try {
          const { toast } = require('@/hooks/use-toast');
          toast({
            title: "Connection Interrupted",
            description: `Reconnecting in ${Math.round(delay/1000)} seconds... (Attempt ${newAttempts})`,
            variant: "default",
            duration: 3000
          });
        } catch (toastError) {
          console.warn('Failed to display reconnection notification:', toastError);
        }

        setTimeout(() => {
          if (!get().isConnected && !get().isOfflineMode) {
            get().initializeWebSocket();
          }
        }, delay);
      }
    },

    sendMessage: (text: string, sender: string, avatar: string) => {
      // ุฅูุดุงุก ูุงุฆู ุงูุฑุณุงูุฉ ุจุดูู ุฃูุซุฑ ุฃูุงูุงู ูุน ุงูุฎุชู ุงูุฒููู ุงูููุญุฏ
      const timestamp = Date.now();
      const message: Message = {
        id: `msg_${timestamp}_${Math.floor(Math.random() * 10000)}`,
        text,
        sender,
        avatar,
        timestamp
      };

      // ุงูุญุตูู ุนูู ุญุงูุฉ ุงูุงุชุตุงู ูุงููุถุน ูู ุงููุฎุฒู
      const { socket, isConnected, isOfflineMode, pendingMessages } = get();

      // ุฅุฐุง ูุงู ูู ูุถุน ุนุฏู ุงูุงุชุตุงูุ ูุฎุฒู ุงูุฑุณุงูุฉ ูููุฒุงููุฉ ูุงุญูุงู
      if (isOfflineMode) {
        console.log('Message sent in offline mode, will be saved for later sync');

        // ุฅุถุงูุฉ ุงูุฑุณุงูุฉ ุฅูู ูุงุฆูุฉ ุงูุฑุณุงุฆู ุงููุนููุฉ
        set(state => ({
          pendingMessages: [...state.pendingMessages, message]
        }));

        // ุญูุธ ุงูุฑุณุงุฆู ุงููุนููุฉ ูู ุงูุชุฎุฒูู ุงููุญูู
        try {
          const allPendingMessages = [...pendingMessages, message];
          saveToLocalStorage('pending_messages', allPendingMessages);
        } catch (storageError) {
          console.warn('Failed to save pending messages to local storage:', storageError);
        }
      }
      // ูุญุงููุฉ ุงูุฅุฑุณุงู ุนุจุฑ WebSocket ุฅุฐุง ูุงู ุงูุงุชุตุงู ูุชุงุญุงู
      else if (isConnected && socket && 'send' in socket && typeof socket.send === 'function') {
        try {
          // ุฅุนุฏุงุฏ ูุงุฆู ุฑุณุงูุฉ ููุฅุฑุณุงู ุนุจุฑ WebSocket ูุน ุชุดููุฑ ุจุณูุท (base64)
          const wsMessage = {
            type: 'message',
            message: {
              ...message,
              // ุชุดููุฑ ุจุณูุท ููุนุฑุถ ููุท
              encrypted: true,
              text: btoa(encodeURIComponent(text)) // ุชุดููุฑ ุจุณูุท ููุนุฑุถ ููุท
            }
          };

          // ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุฅูู ุงูุฎุงุฏู
          socket.send(JSON.stringify(wsMessage));
          console.log('Message sent to server via WebSocket');
        } catch (wsError) {
          console.error('Error sending message via WebSocket, saving locally only:', wsError);

          // ุฅุถุงูุฉ ุงูุฑุณุงูุฉ ูููุนููุฉ ูู ุญุงูุฉ ูุดู ุงูุฅุฑุณุงู
          set(state => ({
            pendingMessages: [...state.pendingMessages, message]
          }));
        }
      } else {
        console.log('No active WebSocket connection, saving message locally only');
      }

      // ูู ุฌููุน ุงูุญุงูุงุชุ ูุถูู ุงูุฑุณุงูุฉ ุฅูู ุงูุฑุณุงุฆู ุงููุญููุฉ ููุนุฑุถ ุงูููุฑู
      set(state => {
        const newMessages = [...state.messages, message];

        // ุญูุธ ุงูุฑุณุงุฆู ูู ุงูุชุฎุฒูู ุงููุญูู (ุจุงูุชูุณูู ุงููุฏูู ูุงูุฌุฏูุฏ)
        try {
          localStorage.setItem('chat_messages', JSON.stringify(newMessages));
          saveToLocalStorage('chat_data', newMessages);
        } catch (storageError) {
          console.warn('Failed to save messages to local storage:', storageError);
        }

        return { messages: newMessages };
      });

      // ุชุณุฌูู ูู ูุญุฏุฉ ุงูุชุญูู ููุชุตุญูุญ
      console.log('New message sent and saved locally:', message);

      // ุฅุฐุง ููุง ูู ูุถุน ุงููุญุงูุงุฉ ุงููุญููุฉ ุฃู ูุถุน ุนุฏู ุงูุงุชุตุงูุ ูุณุชูุฑ ูู ุฅูุดุงุก ุฑุฏูุฏ ุงูุชุฑุงุถูุฉ
      if (isOfflineMode || !socket || !('send' in socket) || typeof socket.send !== 'function') {
        // ูุญุงูุงุฉ ุงูุญุตูู ุนูู ุฑุณุงูุฉ ุฑุฏ ูู ูุณุชุฎุฏู ุขุฎุฑ (ููุท ููุนุฑุถ)
        setTimeout(() => {
          if (Math.random() > 0.7) { // 30% ูุฑุตุฉ ููุฑุฏ ุงูุชููุงุฆู
            const autoResponse: Message = {
              id: `auto_${Date.now()}_${Math.floor(Math.random() * 10000)}`,
              text: `Auto-reply to: "${text.substring(0, 15)}${text.length > 15 ? '...' : ''}"`,
              sender: 'Another User',
              avatar: `https://api.dicebear.com/7.x/initials/svg?seed=${Math.random()}`,
              timestamp: Date.now() + 1000
            };

            // ุฅุถุงูุฉ ุงูุฑุณุงูุฉ ุฅูู ุงูุญุงูุฉ
            set(state => {
              const newMessages = [...state.messages, autoResponse];
              try {
                localStorage.setItem('chat_messages', JSON.stringify(newMessages));
                saveToLocalStorage('chat_data', newMessages);
              } catch (error) {
                console.warn('Failed to save auto-reply to local storage:', error);
              }
              return { messages: newMessages };
            });

            // ุฅุฑุณุงู ุฅุดุนุงุฑ ููุฑุฏ ุงูุชููุงุฆู ุฅุฐุง ูุงูุช ุงูุตูุญุฉ ุบูุฑ ูุดุทุฉ
            try {
              if (!document.hasFocus()) {
                NotificationService.sendChatMessage({
                  sender: autoResponse.sender,
                  text: autoResponse.text
                });
              }
            } catch (notifyError) {
              console.warn('Could not send notification for auto-reply:', notifyError);
            }
          }
        }, 1500 + Math.random() * 2000); // ุฑุฏ ุนุดูุงุฆู ุจูู 1.5 ู 3.5 ุซูุงูู
      }
    },

    // ุชูููู ูุถุน ุนุฏู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช
    enableOfflineMode: () => {
      try {
        if (typeof window === 'undefined') return;

        // ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงููุถุน ููุนู ุจุงููุนู
        if (get().isOfflineMode) {
          console.log('Offline mode already enabled');
          return;
        }

        // ุฅุนุงุฏุฉ ุชุนููู ุนุฏุงุฏ ุงููุญุงููุงุช ุงููุงุดูุฉ
        localStorage.removeItem('ws_failed_attempts');

        // ุชุฎุฒูู ุงูุฑุณุงุฆู ุงูุญุงููุฉ ูุจู ุชูููู ูุถุน ุนุฏู ุงูุงุชุตุงู
        const messages = get().messages;
        saveToLocalStorage('chat_data_offline', messages);

        // ูุทุน ุงุชุตุงู WebSocket ุฅุฐุง ูุงู ููุฌูุฏุงู
        const socket = get().socket;
        if (socket && 'close' in socket && typeof socket.close === 'function') {
          socket.close();
        }

        set({
          isOfflineMode: true,
          isConnected: false,
          socket: null
        });

        console.log('Offline mode enabled. Messages will be stored locally only.');

        // ุฅุธูุงุฑ ุฅุดุนุงุฑ ูููุณุชุฎุฏู
        try {
          const { toast } = require('@/hooks/use-toast');
          toast({
            title: "Offline Mode Activated",
            description: "Data will be stored locally. You can return to live mode later.",
            variant: "default",
            duration: 5000
          });
        } catch (toastError) {
          console.warn('Failed to display offline mode activation notification:', toastError);
        }

        // ุชุฎุฒูู ุญุงูุฉ ูุถุน ุนุฏู ุงูุงุชุตุงู
        localStorage.setItem('offlineMode', 'enabled');
      } catch (error) {
        console.error('Error enabling offline mode:', error);
      }
    },

    // ุชุนุทูู ูุถุน ุนุฏู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช ูุงูุนูุฏุฉ ูููุถุน ุงูุทุจูุนู
    disableOfflineMode: () => {
      try {
        if (typeof window === 'undefined') return;

        set({ isOfflineMode: false });
        // ุฅุฒุงูุฉ ููุง ุงูููุชุงุญูู ููุชูุงูู ูุน ุงูุฅุตุฏุงุฑุงุช ุงูุณุงุจูุฉ
        localStorage.removeItem('offlineMode');
        localStorage.removeItem('offline_mode');
        localStorage.removeItem('ws_failed_attempts');

        // ุฅุธูุงุฑ ุฅุดุนุงุฑ ูููุณุชุฎุฏู
        try {
          const { toast } = require('@/hooks/use-toast');
          toast({
            title: "Connecting to Server",
            description: "Attempting to connect and sync data...",
            variant: "default",
            duration: 3000
          });
        } catch (toastError) {
          console.warn('Failed to display offline mode deactivation notification:', toastError);
        }

        // ุฅุนุงุฏุฉ ุชููุฆุฉ ุงุชุตุงู WebSocket
        get().initializeWebSocket();

        // ูุฒุงููุฉ ุงูุฑุณุงุฆู ุงููุฎุฒูุฉ ูุญููุงู ุจุนุฏ ุชุฃุฎูุฑ ูุตูุฑ (ูุถูุงู ุฅูุดุงุก ุงูุงุชุตุงู ุฃููุงู)
        setTimeout(() => {
          get().syncMessages();
        }, 2000);

        console.log('Offline mode disabled, attempting to reconnect.');
      } catch (error) {
        console.error('Error disabling offline mode:', error);
      }
    },

    // ูุฒุงููุฉ ุงูุฑุณุงุฆู ุงููุฎุฒูุฉ ูุญููุงู ูุน ุงูุฎุงุฏู
    syncMessages: async () => {
      try {
        if (typeof window === 'undefined') return;

        const { socket, pendingMessages, messages, isConnected } = get();

        // ุงูุชุญูู ูู ูุฌูุฏ ุงุชุตุงู ูุดุท
        if (!isConnected || !socket || !('send' in socket) || typeof socket.send === 'function') {
          console.warn('Cannot sync messages: no active server connection');
          return;
        }

        // ุชุญุถูุฑ ุงูุฑุณุงุฆู ูููุฒุงููุฉ - ุงุณุชุฎุฏุงู ุงูุฑุณุงุฆู ุงููุนููุฉ ุฃู ุงุณุชุนุงุฏุฉ ูู ุงูุชุฎุฒูู ุงููุญูู
        let messagesToSync: Message[] = [...pendingMessages];

        // ุฅุฐุง ูู ููู ููุงู ุฑุณุงุฆู ูุนููุฉ ูู ุงูุฐุงูุฑุฉุ ูุญุงูู ุงุณุชุนุงุฏุชูุง ูู ุงูุชุฎุฒูู ุงููุญูู
        if (messagesToSync.length === 0) {
          const savedPending = getFromLocalStorage<Message[]>('pending_messages', []);
          messagesToSync = savedPending;
        }

        // ุฅุฐุง ูู ูุฌุฏ ุฃู ุฑุณุงุฆู ูุนููุฉ ูููุฒุงููุฉุ ูุฎุฑุฌ
        if (messagesToSync.length === 0) {
          console.log('No pending messages to sync');
          return;
        }

        console.log(`Syncing ${messagesToSync.length} messages with the server...`);

        // ุฅุฑุณุงู ุงูุฑุณุงุฆู ูููุฒุงููุฉ ุจุดูู ูุชุนุงูุจ
        for (const message of messagesToSync) {
          try {
            const wsMessage = {
              type: 'message',
              message,
              isSync: true
            };

            socket.send(JSON.stringify(wsMessage));
            await new Promise(resolve => setTimeout(resolve, 100)); // ุงูุชุธุงุฑ ูุตูุฑ ุจูู ูู ุฑุณุงูุฉ
          } catch (sendError) {
            console.error('Error syncing message:', sendError);
            // ุชุณุฌูู ุงูุฑุณุงูุฉ ููุนููุฉ
            set(state => ({
              pendingMessages: [...state.pendingMessages, message]
            }));
          }
        }

        // ุชุญุฏูุซ ููุช ุขุฎุฑ ูุฒุงููุฉ ูุญูุธู
        const syncTime = Date.now();
        set({ lastSyncTimestamp: syncTime, pendingMessages: [] });
        localStorage.setItem('last_sync_timestamp', syncTime.toString());

        console.log('Messages synced successfully');

        // ุชุญุฏูุซ ุงูุชุฎุฒูู ุงููุคูุช ุจุงูุจูุงูุงุช ุงููุญุฏุซุฉ
        saveToLocalStorage('chat_data', get().messages);
      } catch (error) {
        console.error('Error syncing messages:', error);
      }
    },

    // ูุณุญ ุฌููุน ุงูุฑุณุงุฆู ูู ุงููุฎุฒู ุงููุคูุช
    clearMessages: () => {
      try {
        if (typeof window === 'undefined') return;

        set({ messages: [] });
        localStorage.removeItem('chat_messages');
        localStorage.removeItem('chat_data');
        console.log('All messages cleared from cache');
      } catch (error) {
        console.error('Error clearing messages:', error);
      }
    }
  };
});